#!/usr/bin/zsh

ABSOLUTE_PATH=$(realpath $0)
DIR_PATH=$(dirname $ABSOLUTE_PATH)
PATH_TO_AGENT="/home/aman/Desktop/chains/sbom.exe/watchdog-agent/target/watchdog-agent-0.13.1-SNAPSHOT.jar"
ARGS_FOR_AGENT="sbom=bomi.jsonl,skipShutdown=false"
PATH_TO_JAR="$DIR_PATH/pdfbox/app/target/pdfbox-app-3.0.2.jar"

workloads=()
for i in $DIR_PATH/workload/*; do
    workloads+=($i)
done

temp_dir=$(mktemp -d)

trap "rm -rf $temp_dir" EXIT

for i in ${workloads[@]}; do
    extension="${i##*.}"
    name_without_extension=$(basename $i .${extension})

    echo "Encrypt " $i
    java -javaagent:"${PATH_TO_AGENT}"="${ARGS_FOR_AGENT}" -jar ${PATH_TO_JAR} encrypt -O 123 -U 123 --input ${i} --output ${temp_dir}/${name_without_extension}-locked.pdf
    exit_code=$?
    if [ $exit_code -ne 0 ]; then
        echo "Failed to encrypt " $i
        exit $exit_code
    fi
done
