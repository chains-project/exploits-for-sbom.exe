#!/usr/bin/zsh

ABSOLUTE_PATH=$(realpath $0)
DIR_PATH=$(dirname $ABSOLUTE_PATH)
PATH_TO_AGENT="/home/aman/Desktop/chains/sbom.exe/watchdog-agent/target/watchdog-agent-0.13.1-SNAPSHOT.jar"
ARGS_FOR_AGENT="sbom=bomi.jsonl,skipShutdown=true"
PATH_TO_JAR="$DIR_PATH/pdfbox-app-3.0.2.jar"

workloads=()
for i in $DIR_PATH/workload/*; do
    workloads+=($i)
done

temp_dir=$(mktemp -d)

trap "rm -rf $temp_dir" EXIT

check_for_exit_code() {
    if [ $1 -ne 0 ]; then
        echo "$3 " $2
        exit $1
    fi
}

for i in ${workloads[@]}; do
    extension="${i##*.}"
    name_without_extension=$(basename $i .${extension})

    echo "Encrypt " $i
    java -javaagent:"${PATH_TO_AGENT}"="${ARGS_FOR_AGENT}" -jar ${PATH_TO_JAR} encrypt -O 123 -U 123 --input ${i} --output ${temp_dir}/${name_without_extension}-locked.pdf
    exit_code=$?
    check_for_exit_code $exit_code $i "Failed to encrypt"

    echo "Decrypt " $i
    java -javaagent:"${PATH_TO_AGENT}"="${ARGS_FOR_AGENT}" -jar ${PATH_TO_JAR} decrypt -password 123 --input ${temp_dir}/${name_without_extension}-locked.pdf --output ${temp_dir}/${name_without_extension}-unlocked.pdf
    exit_code=$?
    check_for_exit_code $exit_code $i "Failed to decrypt"

    echo "Extract Text " $i
    java -javaagent:"${PATH_TO_AGENT}"="${ARGS_FOR_AGENT}" -jar ${PATH_TO_JAR} export:text --input ${temp_dir}/${name_without_extension}-unlocked.pdf --output ${temp_dir}/${name_without_extension}-text.txt
    exit_code=$?
    check_for_exit_code $exit_code $i "Failed to extract text"

    echo "Extract Image " $i
    java -javaagent:"${PATH_TO_AGENT}"="${ARGS_FOR_AGENT}" -jar ${PATH_TO_JAR} export:images --input ${temp_dir}/${name_without_extension}-unlocked.pdf
    exit_code=$?
    check_for_exit_code $exit_code $i "Failed to extract image"

    echo "Render " $i
    java -javaagent:"${PATH_TO_AGENT}"="${ARGS_FOR_AGENT}" -jar ${PATH_TO_JAR} render --input ${temp_dir}/${name_without_extension}-unlocked.pdf
    exit_code=$?
    check_for_exit_code $exit_code $i "Failed to render"

    echo "From Text " $i
    java -javaagent:"${PATH_TO_AGENT}"="${ARGS_FOR_AGENT}" -jar ${PATH_TO_JAR} fromtext --input ${temp_dir}/${name_without_extension}-text.txt --output ${temp_dir}/${name_without_extension}-from-text.pdf -standardFont Times-Roman
    exit_code=$?
    check_for_exit_code $exit_code $i "Failed to create pdf from text"

    echo "Split " $i
    java -javaagent:"${PATH_TO_AGENT}"="${ARGS_FOR_AGENT}" -jar ${PATH_TO_JAR} split --input ${temp_dir}/${name_without_extension}-unlocked.pdf -split 3 -outputPrefix "${temp_dir}/split-${name_without_extension}".pdf
    exit_code=$?
    check_for_exit_code $exit_code $i "Failed to split pdf"

    echo "Merge " $i
    java -javaagent:"${PATH_TO_AGENT}"="${ARGS_FOR_AGENT}" -jar ${PATH_TO_JAR} merge --input "${temp_dir}/split-${name_without_extension}".pdf-1.pdf --output "${temp_dir}/merged-${name_without_extension}".pdf
    exit_code=$?
    check_for_exit_code $exit_code $i "Failed to merge pdf"

    echo "Decode " $i
    java -javaagent:"${PATH_TO_AGENT}"="${ARGS_FOR_AGENT}" -jar ${PATH_TO_JAR} decode ${temp_dir}/${name_without_extension}-unlocked.pdf ${temp_dir}/${name_without_extension}-decoded.pdf
    exit_code=$?
    check_for_exit_code $exit_code $i "Failed to decode pdf"

    echo "Overlay " $i
    java -javaagent:"${PATH_TO_AGENT}"="${ARGS_FOR_AGENT}" -jar ${PATH_TO_JAR} overlay -default $i --input ${temp_dir}/${name_without_extension}-unlocked.pdf  --output ${temp_dir}/${name_without_extension}-overlay.pdf
    exit_code=$?
    check_for_exit_code $exit_code $i "Failed to overlay pdf"
done
